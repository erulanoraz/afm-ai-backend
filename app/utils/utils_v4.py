# app/utils/utils_v4.py
from __future__ import annotations
import re
from datetime import datetime

# ============================================================
# üîπ –£–¥–∞–ª–µ–Ω–∏–µ —Å—Å—ã–ª–æ–∫ [uuid:page] –∏–∑ —Ç–µ–∫—Å—Ç–∞
# ============================================================

SOURCE_TAG_RX = re.compile(r"\[[0-9a-fA-F\-]{36}:\d+\]")

def remove_source_tags(text: str) -> str:
    """
    –£–¥–∞–ª—è–µ—Ç —Å—Å—ã–ª–∫–∏ –≤–∏–¥–∞ [uuid:page] –∏–∑ —Ç–µ–∫—Å—Ç–∞.
    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é.
    """
    if not text:
        return ""
    return SOURCE_TAG_RX.sub("", text).strip()


# ============================================================
# üîπ –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞—Ç—ã "DD.MM.YYYY" ‚Üí "17 –Ω–æ—è–±—Ä—è 2025 –≥–æ–¥–∞"
# ============================================================

def format_russian_date(date_str: str) -> str:
    """
    –ü—Ä–∏–Ω–∏–º–∞–µ—Ç —Å—Ç—Ä–æ–∫—É –≤–∏–¥–∞:
        ‚Ä¢ DD.MM.YYYY
        ‚Ä¢ YYYY-MM-DD

    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
        ‚Ä¢ '17 –Ω–æ—è–±—Ä—è 2025 –≥–æ–¥–∞'
    """
    if not date_str:
        return date_str

    try:
        if re.fullmatch(r"\d{4}-\d{2}-\d{2}", date_str):
            dt = datetime.fromisoformat(date_str)
        else:
            dt = datetime.strptime(date_str, "%d.%m.%Y")
    except Exception:
        return date_str

    months = [
        "—è–Ω–≤–∞—Ä—è", "—Ñ–µ–≤—Ä–∞–ª—è", "–º–∞—Ä—Ç–∞", "–∞–ø—Ä–µ–ª—è", "–º–∞—è", "–∏—é–Ω—è",
        "–∏—é–ª—è", "–∞–≤–≥—É—Å—Ç–∞", "—Å–µ–Ω—Ç—è–±—Ä—è", "–æ–∫—Ç—è–±—Ä—è", "–Ω–æ—è–±—Ä—è", "–¥–µ–∫–∞–±—Ä—è",
    ]

    return f"{dt.day} {months[dt.month - 1]} {dt.year} –≥–æ–¥–∞"


# ============================================================
# üîπ –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Ö–æ–¥–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
# ============================================================

def validate_docs(docs: list[dict]) -> None:
    """
    –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º Qualifier 4.0.
    """
    if not docs:
        raise ValueError("‚ùå –ù–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞. –ó–∞–≥—Ä—É–∑–∏—Ç–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã –¥–µ–ª–∞.")

    empty = [d for d in docs if not (d.get('text') or '').strip()]
    if len(empty) == len(docs):
        raise ValueError("‚ùå –í—Å–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –ø—É—Å—Ç—ã–µ –∏–ª–∏ –±–µ–∑ —Ç–µ–∫—Å—Ç–∞.")
