# app/services/agents/ai_extractor.py
import re
import logging
from collections import defaultdict
from datetime import datetime

logger = logging.getLogger(__name__)

# ============================================================
# üß†  AI-Extractor ‚Äî –æ—Å–Ω–æ–≤–Ω–æ–π –º–æ–¥—É–ª—å —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–∏—è —Ñ–∞–∫—Ç–æ–≤
# ============================================================

ROLE_KEYWORDS = {
    "suspect": ["–ø–æ–¥–æ–∑—Ä–µ–≤–∞–µ–º", "–ø–æ–¥–æ–∑—Ä–µ–≤–∞–µ–º—ã–π", "–∑–∞–∫–∏–µ–≤", "—Ä–∞–º–∞–∑–∞–Ω–æ–≤"],
    "victim": ["–ø–æ—Ç–µ—Ä–ø–µ–≤—à", "–∂–µ—Ä—Ç–≤–∞", "–Ω—É—Ä–∫–∏–º–±–∞–µ–≤–∞", "–±–µ–∫–æ–≤–∞", "–∫–æ—Ö", "–∫—É—Å–∞–∏–Ω–æ–≤"],
    "witness": ["—Å–≤–∏–¥–µ—Ç–µ–ª", "–ø–æ–∫–∞–∑–∞–Ω–∏—è –¥–∞–ª", "–¥–æ–ø—Ä–æ—Å —Å–≤–∏–¥–µ—Ç–µ–ª—è"],
    "expert": ["—ç–∫—Å–ø–µ—Ä—Ç", "—Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç", "–∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω", "—ç–∫—Å–ø–µ—Ä—Ç–∏–∑"],
    "afm": ["—Å–æ—Ç—Ä—É–¥–Ω–∏–∫ –∞—Ñ–º", "—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å", "–∑–∞–∫–∏–µ–≤", "—à–∞–∫–µ–Ω–æ–≤"],
    "accused": ["–æ–±–≤–∏–Ω—è–µ–º—ã–π"],
}

DATE_REGEX = r"\b(\d{2}\.\d{2}\.\d{4})\b"
AMOUNT_REGEX = r"\b(\d[\d\s]{0,12}(?:—Ç–µ–Ω–≥–µ|‚Ç∏))"


# ============================================================
# üîé –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –∏–º—ë–Ω
# ============================================================

def normalize_persons(persons: list[str]) -> dict:
    """
    –ü—Ä–∏–≤–æ–¥–∏—Ç –≤—Å–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –Ω–∞–ø–∏—Å–∞–Ω–∏—è –æ–¥–Ω–æ–π —Ñ–∞–º–∏–ª–∏–∏ –∫ –µ–¥–∏–Ω–æ–º—É –≤–∏–¥—É.
    """
    clusters = defaultdict(list)

    for p in persons:
        clean = re.sub(r"\s+", " ", p).strip()
        base = clean.lower()

        # –∫–ª—é—á –ø–æ —Ñ–∞–º–∏–ª–∏–∏
        last_name = base.split()[0]
        clusters[last_name].append(clean)

    result = {k: list(set(v)) for k, v in clusters.items()}
    return result


# ============================================================
# üî• –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ä–æ–ª–µ–π
# ============================================================

def extract_roles(facts: list[dict], persons: list[str]) -> dict:
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
    {
        'suspect': [...],
        'victim': [...],
        'witness': [...],
        'afm': [...],
        'expert': [...],
        'accused': [...],
        'other': [...]
    }
    """
    roles = defaultdict(list)
    normalized = normalize_persons(persons)

    for raw_name_group in normalized.values():
        name_variants = [n.lower() for n in raw_name_group]

        assigned = False
        for role, keys in ROLE_KEYWORDS.items():
            if any(k in nv for nv in name_variants for k in keys):
                roles[role].extend(raw_name_group)
                assigned = True
                break

        if not assigned:
            roles["other"].extend(raw_name_group)

    logger.info(f"üé≠ –û–ø—Ä–µ–¥–µ–ª–µ–Ω—ã —Ä–æ–ª–∏: {dict(roles)}")
    return dict(roles)


# ============================================================
# üî• –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π
# ============================================================

def extract_events(facts: list[dict]) -> list[dict]:
    """
    –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç —Ñ–∞–∫—Ç—ã –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è.
    –§–æ—Ä–º–∞—Ç:
    {
        'date': '2024-01-01',
        'text': '...',
        'persons': [...],
        'amounts': [...],
        'location': '...',
        'action': '–ø–æ–ª—É—á–∏–ª –¥–µ–Ω—å–≥–∏ / –ø–µ—Ä–µ–¥–∞–ª / –æ–±–º–∞–Ω—É–ª'
    }
    """

    structured = []

    for f in facts:
        text = f["text"]

        # –¥–∞—Ç—ã
        dates = re.findall(DATE_REGEX, text)

        # —Å—É–º–º—ã
        amounts = re.findall(AMOUNT_REGEX, text)

        # –ª–∏—Ü–∞
        persons = []
        if "suspect" in f:
            persons.append(f["suspect"])
        if "victim" in f:
            persons.append(f["victim"])
        if "witness" in f:
            persons.append(f["witness"])

        # –¥–µ–π—Å—Ç–≤–∏—è
        action = None
        for word in ["–ø–µ—Ä–µ–¥–∞–ª", "–ø–æ–ª—É—á–∏–ª", "–≤–∑—è–ª", "–æ–±–º–∞–Ω—É–ª", "–ø–æ–ª—É—á–∏–ª–∞", "–ø–µ—Ä–µ–≤–µ–ª–∞"]:
            if word in text.lower():
                action = word
                break

        structured.append({
            "date": dates[0] if dates else None,
            "text": text,
            "persons": persons,
            "amounts": amounts,
            "action": action,
            "location": None,  # –º–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å –ø–æ–∑–∂–µ
        })

    logger.info(f"üß© –ò–∑–≤–ª–µ—á–µ–Ω–æ {len(structured)} —Å–æ–±—ã—Ç–∏–π")
    return structured


# ============================================================
# ‚öñÔ∏è –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —é—Ä–∏–¥–∏—á–µ—Å–∫–∏ –∑–Ω–∞—á–∏–º—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
# ============================================================

def extract_legal_facts(events: list[dict], roles: dict) -> dict:
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —é—Ä–∏–¥–∏—á–µ—Å–∫–∏–µ –ø—Ä–∏–∑–Ω–∞–∫–∏:
    """

    legal = {
        "object": "–ü—Ä–∞–≤–∞ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ –≥—Ä–∞–∂–¥–∞–Ω",
        "objective_side": [],
        "subject": roles.get("suspect", []),
        "consequences": [],
        "method": [],
        "intent": None,
        "motive": None,
        "damage": [],
    }

    for e in events:
        txt = e["text"].lower()

        # —É—â–µ—Ä–±
        if e["amounts"]:
            legal["damage"].extend(e["amounts"])

        # –¥–µ–π—Å—Ç–≤–∏—è –ø—Ä–µ—Å—Ç—É–ø–Ω—ã–µ
        if e["action"]:
            legal["objective_side"].append(f"{','.join(e['persons'])} {e['action']} {','.join(e['amounts'])}")

        # —É–º—ã—Å–µ–ª
        if "–∑–∞—Ä–∞–Ω–µ–µ" in txt or "–ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω" in txt:
            legal["intent"] = "–ü—Ä—è–º–æ–π —É–º—ã—Å–µ–ª"

        # –º–æ—Ç–∏–≤
        if "—Å —Ü–µ–ª—å—é" in txt:
            legal["motive"] = txt.split("—Å —Ü–µ–ª—å—é")[1][:50]

    return legal


# ============================================================
# üìÖ –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ —Ö—Ä–æ–Ω–æ–ª–æ–≥–∏–∏
# ============================================================

def build_timeline(events: list[dict]) -> list[dict]:
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ —Å–æ–±—ã—Ç–∏–π –ø–æ –¥–∞—Ç–µ.
    """
    cleaned = []
    for e in events:
        if not e["date"]:
            continue
        try:
            dt = datetime.strptime(e["date"], "%d.%m.%Y")
            cleaned.append((dt, e))
        except:
            continue

    cleaned.sort(key=lambda x: x[0])
    result = [e for _, e in cleaned]

    logger.info(f"üìÖ –•—Ä–æ–Ω–æ–ª–æ–≥–∏—è —Å–æ–±—ã—Ç–∏–π: {len(result)} —ç–ª–µ–º–µ–Ω—Ç–æ–≤")
    return result


def is_crime_related(text):
    text = text.lower()

    crime_keywords = [

        # üî• –§–ò–ù–ê–ù–°–û–í–´–ï –ü–ò–†–ê–ú–ò–î–´ / –ú–æ—à–µ–Ω–Ω–∏—á–µ—Å—Ç–≤–æ
        "—Ñ–∏–Ω–∞–Ω—Å–æ–≤", "–ø–∏—Ä–∞–º–∏", "–∏–Ω–≤–µ—Å—Ç–∏—Ü", "–≤—ã—Å–æ–∫–∏–π –¥–æ—Ö–æ–¥", "–≤–ª–æ–∂–µ–Ω–∏",
        "–æ–±–º–∞–Ω", "–∑–∞–≤–µ–¥–æ–º–æ", "–≤–≤–µ–ª –≤ –∑–∞–±–ª—É–∂–¥–µ–Ω–∏–µ", "–º–æ—à–µ–Ω–Ω–∏—á", "–Ω–µ–∑–∞–∫–æ–Ω–Ω–æ",

        # üí∞ –î–ï–ù–¨–ì–ò / –ü–ï–†–ï–í–û–î–´ / –£–©–ï–†–ë
        "–ø–µ—Ä–µ–≤–µ–ª", "–ø–µ—Ä–µ–≤—ë–ª", "–ø–µ—Ä–µ—á–∏—Å–ª–∏–ª", "–ø–æ–ª—É—á–∏–ª", "–ø–æ–ª—É—á–∏–ª–∞",
        "—Å–Ω—è–ª", "—Å–Ω—è–ª–∞", "–≤—ã–≤–µ–ª", "–≤—ã–≤–µ–ª–∞", "–≤—ã–≤–æ–¥ —Å—Ä–µ–¥—Å—Ç–≤",
        "—É—â–µ—Ä–±", "–º–∞—Ç–µ—Ä–∏–∞–ª—å–Ω—ã–π –≤—Ä–µ–¥", "–¥–µ–Ω–µ–∂–Ω", "–∫—Ä—É–ø–Ω—ã–π —Ä–∞–∑–º–µ—Ä",
        "–æ—Å–æ–±–æ –∫—Ä—É–ø–Ω—ã–π", "—Ö–∏—â–µ–Ω–∏", "–ø—Ä–∏—Å–≤–æ–µ–Ω–∏",

        # üßæ –î–û–ì–û–í–û–†–´ / –§–ò–ö–¢–ò–í–ù–´–ï –°–î–ï–õ–ö–ò
        "—Ñ–∏–∫—Ç–∏–≤", "–ø–æ–¥–ª–æ–∂–Ω", "–ø–æ–¥–¥–µ–ª—å–Ω", "–ø–æ–¥–¥–µ–ª–∞–ª", "–ø–æ–¥–ø–∏—Å–∞–ª –¥–æ–≥–æ–≤–æ—Ä",
        "–ª–æ–∂–Ω—ã–µ", "–Ω–µ–¥–æ—Å—Ç–æ–≤–µ—Ä–Ω—ã–µ —Å–≤–µ–¥–µ–Ω–∏—è", "—Ñ–∏–∫—Ç–∏–≤–Ω—ã–π –¥–æ–≥–æ–≤–æ—Ä",        
        "–Ω–µ –∏–º–µ–ª –Ω–∞–º–µ—Ä–µ–Ω–∏—è –∏—Å–ø–æ–ª–Ω—è—Ç—å",

        # üè¢ –û–†–ì–ê–ù–ò–ó–ê–¶–ò–Ø –ü–†–ï–°–¢–£–ü–ù–û–ô –°–•–ï–ú–´
        "–æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä", "—Ä—É–∫–æ–≤–æ–¥–∏–ª", "—É—á—Ä–µ–¥–∏–ª", "—Å–æ–∑–¥–∞–ª", "—Å—Ç—Ä—É–∫—Ç—É—Ä–∞",
        "—Å–≥–æ–≤–æ—Ä", "–≥—Ä—É–ø–ø–æ–π –ª–∏—Ü", "–ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π —Å–≥–æ–≤–æ—Ä", 

        # üë• –ü–†–ò–í–õ–ï–ß–ï–ù–ò–ï –ì–†–ê–ñ–î–ê–ù / –£–ß–ê–°–¢–ù–ò–ö–û–í
        "–ø—Ä–∏–≤–ª–µ–∫", "–ø—Ä–∏–≤–ª–µ–∫–∞–ª", "–∞–≥–∏—Ç–∏—Ä–æ–≤–∞–ª", "—É—á–∞—Å—Ç–Ω–∏–∫", "–≤—Å—Ç—É–ø–∏–ª",
        "—É—á–∞—Å—Ç–∏–µ", "–ø–æ—Ç–µ—Ä–ø–µ–≤—à", "—Å–æ—É—á–∞—Å—Ç–Ω–∏–∫", "–∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å", "—Å–≤–∏–¥–µ—Ç–µ–ª—å—Å—Ç–≤",

        # üßÆ –ë–ê–ù–ö–û–í–°–ö–ò–ï –û–ü–ï–†–ê–¶–ò–ò
        "–±–∞–Ω–∫–æ–≤—Å–∫", "—Å—á–µ—Ç", "—Å—á–µ—Ç–∞", "–∫–∞—Ä—Ç–∞", "–ø–µ—Ä–µ–≤–æ–¥", "–ø–ª–∞—Å—Ç–∏–∫–æ–≤–∞—è –∫–∞—Ä—Ç–∞",
        "–∑–∞—á–∏—Å–ª–µ–Ω–∏", "–æ—Ç–ø—Ä–∞–≤–∏–ª", "–ø–æ–ª—É—á–∞—Ç–µ–ª—å", "—Ä–µ–∫–≤–∏–∑–∏—Ç—ã", "—Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏",
        "—Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π –ø–æ—Ç–æ–∫", "–¥–µ–Ω–µ–∂–Ω—ã–µ —Å—Ä–µ–¥—Å—Ç–≤–∞", "—ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã–π –ø–ª–∞—Ç–µ–∂",

        # üè¶ –û–¢–ú–´–í–ê–ù–ò–ï –î–ï–ù–ï–ì / –õ–ï–ì–ê–õ–ò–ó–ê–¶–ò–Ø
        "–ª–µ–≥–∞–ª–∏–∑–∞—Ü", "–æ—Ç–º—ã–≤–∞–Ω", "–º–∞—Å–∫–∏—Ä–æ–≤", "–ø—Ä–∏–∫—Ä—ã–≤–∞–ª", "—Å–∫—Ä—ã–≤–∞–ª –ø—Ä–æ–∏—Å—Ö–æ–∂–¥–µ–Ω–∏–µ",
        "—Ç—Ä–µ—Ç—å–∏ –ª–∏—Ü–∞", "–ø–æ–¥—Å—Ç–∞–≤–Ω—ã–µ –ª–∏—Ü–∞", "–ø–æ–¥—Å—Ç–∞–≤–Ω–æ–µ –ª–∏—Ü–æ",
        "–æ–±–Ω–∞–ª–∏—á", "–æ–±–Ω–∞–ª–∏—á–∏–≤–∞–ª",

        # üëî –ù–ê–†–£–®–ï–ù–ò–ï –ó–ê–ö–û–ù–ê / –£–ö / –£–ü–ö
        "—Å–æ—Å—Ç–∞–≤ –ø—Ä–µ—Å—Ç—É–ø–ª–µ–Ω", "–∫–≤–∞–ª–∏—Ñ–∏—Ü–∏—Ä—É–µ—Ç—Å—è", "—É–≥–æ–ª–æ–≤–Ω", "–ø—Ä–æ—Ç–∏–≤–æ–∑–∞–∫–æ–Ω",
        "–Ω–µ –∏–º–µ–ª –ª–∏—Ü–µ–Ω–∑–∏–∏", "–Ω–µ–∑–∞–∫–æ–Ω–Ω–æ–µ –ø—Ä–µ–¥–ø—Ä–∏–Ω–∏–º–∞—Ç–µ–ª—å—Å—Ç–≤–æ",
        "—Å—Ç. ", "—Å—Ç–∞—Ç—å—è", "—É–∫ —Ä–∫", "—É–ø–∫ —Ä–∫",

        # üì± –¢–ï–•–ù–û–õ–û–ì–ò–ò / –û–ù–õ–ê–ô–ù-–°–•–ï–ú–´
        "—Ç–µ–ª–µ–≥—Ä–∞–º", "whatsapp", "—á–∞—Ç", "–æ–Ω–ª–∞–π–Ω –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞", "qr-–∫–æ–¥",
        "–ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç", "–∞–∫–∫–∞—É–Ω—Ç", "ip-–∞–¥—Ä–µ—Å", "—Å–∞–π—Ç",
        "–∏–Ω—Ç–µ—Ä–Ω–µ—Ç —Ä–µ—Å—É—Ä—Å", "—Ä–µ–∫–ª–∞–º–∏—Ä–æ–≤–∞–ª",

        # üìÇ –î–û–ö–£–ú–ï–ù–¢–´ / –î–û–ö–ê–ó–ê–¢–ï–õ–¨–°–¢–í–ê
        "–ø—Ä–æ—Ç–æ–∫–æ–ª", "–¥–æ–ø—Ä–æ—Å", "–ø–æ–∫–∞–∑–∞–Ω–∏—è", "–æ–±—ä—è—Å–Ω–µ–Ω–∏—è", "–∏–∑—ä—è–ª–∏",
        "–æ–±—ã—Å–∫", "–ø–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ", "—ç–∫—Å–ø–µ—Ä—Ç–∏–∑–∞", "–∑–∞–∫–ª—é—á–µ–Ω–∏–µ —ç–∫—Å–ø–µ—Ä—Ç–∞",

        # üèõ –Æ–†–ò–î–ò–ß–ï–°–ö–ò–ï –õ–ò–¶–ê / –§–ò–†–ú–´ / –ü–û–î–°–¢–ê–í–ù–´–ï –û–†–ì–ê–ù–ò–ó–ê–¶–ò–ò
        "too", "–æ–æ–æ", "ao", "–∏–ø", "—é—Ä–∏–¥–∏—á–µ—Å–∫–æ–µ –ª–∏—Ü–æ", "–ø–æ–¥—Å—Ç–∞–≤–Ω–æ–µ",
        "—Ñ–∏—Ä–º–∞-–æ–¥–Ω–æ–¥–Ω–µ–≤–∫–∞", "—Ñ–∏–∫—Ç–∏–≤–Ω–∞—è –∫–æ–º–ø–∞–Ω–∏—è", "–∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç",
        "–¥–æ–≥–æ–≤–æ—Ä –∑–∞–π–º–∞", "–¥–æ–≥–æ–≤–æ—Ä –æ–∫–∞–∑–∞–Ω–∏—è —É—Å–ª—É–≥", "—Å—á–µ—Ç-—Ñ–∞–∫—Ç—É—Ä–∞"
    ]

    return any(k in text for k in crime_keywords)


# ============================================================
# üî• –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è EXTRACTOR
# ============================================================

def extract_all(facts, persons, dates, amounts):
    """
    –ì–ª–∞–≤–Ω–∞—è —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –¥–ª—è ai_qualifier.py.
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
    {
        'roles': {...},
        'events': [...],
        'timeline': [...],
        'legal_facts': {...}
    }
    """

    roles = extract_roles(facts, persons)
    events = extract_events(facts)

    timeline = build_timeline(events)
    legal_facts = extract_legal_facts(events, roles)

    return {
        "roles": roles,
        "events": events,
        "timeline": timeline,
        "legal_facts": legal_facts
    }
