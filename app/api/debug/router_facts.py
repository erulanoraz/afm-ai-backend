# app/api/debug/router_facts.py

from fastapi import APIRouter
from pydantic import BaseModel
from typing import List, Dict, Any
import re

from app.utils.sentence_splitter import split_into_sentences

router = APIRouter(
    prefix="/debug/facts",
    tags=["DEBUG â€“ Facts"]
)

class FactsRequest(BaseModel):
    text: str


# ===============================================================
#  ðŸ”µ PROCESSUAL â€” Ð¿Ð¾Ð»Ð½Ð¾ÑÑ‚ÑŒÑŽ ÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¾ Ñ FactFilter 3.0
# ===============================================================
PROCESSUAL_KEYWORDS = [
    "Ñ€Ð°Ð·ÑŠÑÑÐ½ÐµÐ½Ñ‹ Ð¿Ñ€Ð°Ð²Ð°",
    "ÐµÐ¼Ñƒ Ñ€Ð°Ð·ÑŠÑÑÐ½ÐµÐ½Ñ‹ Ð¿Ñ€Ð°Ð²Ð°",
    "ÐµÐ¹ Ñ€Ð°Ð·ÑŠÑÑÐ½ÐµÐ½Ñ‹ Ð¿Ñ€Ð°Ð²Ð°",
    "Ð¸Ð¼ÐµÐµÑ‚ Ð¿Ñ€Ð°Ð²Ð¾",
    "Ð¿Ð°Ð¼ÑÑ‚ÐºÐ° Ð¾ Ð¿Ñ€Ð°Ð²Ð°Ñ…",
    "ÐºÐ¾Ð¿Ð¸ÑŽ Ð¿Ð¾ÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ð»",
    "ÐºÐ¾Ð¿Ð¸ÑŽ Ð¿Ð¾ÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ð»Ð°",
    "Ð´Ð°Ð½Ð½Ð¾Ðµ Ð¿Ð¾ÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¼Ð¾Ð¶ÐµÑ‚ Ð±Ñ‹Ñ‚ÑŒ Ð¾Ð±Ð¶Ð°Ð»Ð¾Ð²Ð°Ð½Ð¾",
    "Ð´Ð°Ð½Ð½Ð¾Ðµ Ð¿Ð¾ÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¼Ð¾Ð¶ÐµÑ‚ Ð±Ñ‹Ñ‚ÑŒ Ð¾Ð±Ð¶Ð°Ð»Ð¾Ð²Ð°Ð½o",
    "Ð´Ð°Ð½Ð½Ð¾Ðµ Ñ€ÐµÑˆÐµÐ½Ð¸Ðµ Ð¼Ð¾Ð¶ÐµÑ‚ Ð±Ñ‹Ñ‚ÑŒ Ð¾Ð±Ð¶Ð°Ð»Ð¾Ð²Ð°Ð½Ð¾",
    "ÑÐ·Ñ‹Ðº ÑÑƒÐ´Ð¾Ð¿Ñ€Ð¾Ð¸Ð·Ð²Ð¾Ð´ÑÑ‚Ð²Ð°",
    "Ð¾ Ð½ÐµÐ´Ð¾Ð¿ÑƒÑÑ‚Ð¸Ð¼Ð¾ÑÑ‚Ð¸ Ñ€Ð°Ð·Ð³Ð»Ð°ÑˆÐµÐ½Ð¸Ñ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð´Ð¾ÑÑƒÐ´ÐµÐ±Ð½Ð¾Ð³Ð¾ Ñ€Ð°ÑÑÐ»ÐµÐ´Ð¾Ð²Ð°Ð½Ð¸Ñ",
    "Ð¿Ñ€ÐµÐ´ÑƒÐ¿Ñ€ÐµÐ¶Ð´ÐµÐ½",
    "Ð¿Ñ€ÐµÐ´ÑƒÐ¿Ñ€ÐµÐ¶Ð´ÐµÐ½Ð°",
    "Ð¿Ð¾Ð´ Ñ€Ð¾ÑÐ¿Ð¸ÑÑŒ Ð¾Ð·Ð½Ð°ÐºÐ¾Ð¼Ð»ÐµÐ½",
    "Ð¿Ð¾Ð´ Ñ€Ð¾ÑÐ¿Ð¸ÑÑŒ Ð¾Ð·Ð½Ð°ÐºÐ¾Ð¼Ð»ÐµÐ½Ð°",
]


PROCESSUAL_TOKEN_TYPES = {
    "procedure",
    "procedural",
    "right",
    "duty",
    "notification",
    "explanation",
    "warning",
    "subscription",
    "copy_delivery",
    "acknowledgement",
    "form",
    "language_proceeding",
    "service",
}


# ===============================================================
#  ðŸ”´ CRIMINAL â€” Ð¢ÐžÐ§ÐÐž ÐºÐ°Ðº Ð² FactFilter
# ===============================================================
CRIME_PATTERNS = [
    r"Ð¿ÐµÑ€ÐµÑ‡Ð¸ÑÐ»[Ð¸Ñ‹Ñƒ][Ð»]?\s+Ð´ÐµÐ½ÐµÐ¶Ð½Ñ‹Ðµ ÑÑ€ÐµÐ´ÑÑ‚Ð²Ð°",
    r"Ð¿ÐµÑ€ÐµÐ²Ð¾Ð´[Ð°Ñ‹]?\s+Ð´ÐµÐ½ÐµÐ¶Ð½Ñ‹Ñ… ÑÑ€ÐµÐ´ÑÑ‚Ð²",
    r"Ð´ÐµÐ½ÐµÐ¶Ð½Ñ‹Ðµ ÑÑ€ÐµÐ´ÑÑ‚Ð²Ð° Ð±Ñ‹Ð»Ð¸ Ð¿ÐµÑ€ÐµÑ‡Ð¸ÑÐ»ÐµÐ½Ñ‹",
    r"Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ð»[Ð°Ð¸]?\s+Ð´ÐµÐ½ÐµÐ¶Ð½Ñ‹Ðµ ÑÑ€ÐµÐ´ÑÑ‚Ð²Ð°",
    r"Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ Ð´ÐµÐ½ÐµÐ³",
    r"Ð²Ð²ÐµÐ»Ð¸ Ð² Ð·Ð°Ð±Ð»ÑƒÐ¶Ð´ÐµÐ½Ð¸Ðµ",
    r"Ð²Ð²Ð¾Ð´ Ð² Ð·Ð°Ð±Ð»ÑƒÐ¶Ð´ÐµÐ½Ð¸Ðµ",
    r"Ð¾Ð±Ð¼Ð°Ð½[ÑƒÐ»]?",
    r"Ð¾Ð±Ð¼Ð°Ð½Ð½Ñ‹Ð¼ Ð¿ÑƒÑ‚ÐµÐ¼",
    r"Ð¾Ð±ÐµÑ‰Ð°Ð½[Ð°Ð¾]?\s+Ð´Ð¾Ñ…Ð¾Ð´",
    r"Ð¾Ð±ÐµÑ‰Ð°Ð»Ð¸ Ð²Ñ‹ÑÐ¾ÐºÐ¸Ð¹ Ð´Ð¾Ñ…Ð¾Ð´",
    r"ÑƒÑ‰ÐµÑ€Ð± Ð½Ð° ÑÑƒÐ¼Ð¼Ñƒ",
    r"Ð¿Ñ€Ð¸Ñ‡Ð¸Ð½ÐµÐ½ ÑƒÑ‰ÐµÑ€Ð±",
    r"Ð¼Ð°Ñ‚ÐµÑ€Ð¸Ð°Ð»ÑŒÐ½Ñ‹Ð¹ ÑƒÑ‰ÐµÑ€Ð±",
    r"Ð¸Ð½Ð²ÐµÑÑ‚Ð¸Ñ†",
    r"Ð²ÐºÐ»Ð°Ð´",
    r"Ð¿Ñ€Ð¾Ñ†ÐµÐ½Ñ‚[Ð°Ñ‹]?",
]

# + Ð±Ð°Ð·Ð¾Ð²Ñ‹Ðµ Ñ‚Ñ€Ð¸Ð³Ð³ÐµÑ€Ñ‹
CRIMINAL_BASE = [
    "Ð¿ÐµÑ€ÐµÐ²Ð¾Ð´", "Ð²Ð»Ð¾Ð¶Ð¸Ð»", "Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ð»", "ÑÑƒÐ¼Ð¼Ð°", "Ñ‚ÐµÐ½Ð³Ðµ", "Ñ‚Ð³", "â‚¸", "Ð¾Ð±Ð¼Ð°Ð½",
    "Ð·Ð°Ð±Ð»ÑƒÐ¶Ð´ÐµÐ½Ð¸Ðµ", "Ñ„Ð¸Ð½Ð°Ð½ÑÐ¾Ð²Ð°Ñ Ð¿Ð¸Ñ€Ð°Ð¼Ð¸Ð´Ð°", "Ð¿Ñ€Ð¾ÐµÐºÑ‚", "Ð´Ð¾Ñ…Ð¾Ð´", "Ð¸Ð½Ð²ÐµÑÑ‚Ð¸Ñ†Ð¸Ð¸",
]


# ===============================================================
#   ðŸ§  ÐšÐ»Ð°ÑÑÐ¸Ñ„Ð¸ÐºÐ°Ñ‚Ð¾Ñ€ â€” IDENTICAL to FactFilter logic
# ===============================================================
def classify_sentence(sentence: str) -> str:
    text = sentence.lower()

    # 1) Ð¿Ñ€Ð¾Ñ†ÐµÑÑÑƒÐ°Ð»ÐºÐ°
    for kw in PROCESSUAL_KEYWORDS:
        if kw in text:
            return "processual"

    # 2) ÐºÑ€Ð¸Ð¼Ð¸Ð½Ð°Ð»ÑŒÐ½Ñ‹Ðµ Ñ€ÐµÐ³ÑÐºÑÐ¿Ñ‹
    for pattern in CRIME_PATTERNS:
        if re.search(pattern, text):
            return "criminal"

    # 3) ÐºÑ€Ð¸Ð¼Ð¸Ð½Ð°Ð»ÑŒÐ½Ñ‹Ðµ Ñ‚Ñ€Ð¸Ð³Ð³ÐµÑ€Ñ‹
    for kw in CRIMINAL_BASE:
        if kw in text:
            return "criminal"

    return "neutral"


# ===============================================================
#   ðŸ” ÐžÑÐ½Ð¾Ð²Ð½Ð¾Ð¹ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº
# ===============================================================
@router.post("/", summary="FactsClassifier 3.0 â€” ÐºÑ€Ð¸Ð¼Ð¸Ð½Ð°Ð» / Ð¿Ñ€Ð¾Ñ†ÐµÑÑÑƒÐ°Ð»ÐºÐ° / Ð½ÐµÐ¹Ñ‚Ñ€Ð°Ð»")
async def debug_facts(req: FactsRequest) -> Dict[str, Any]:
    sentences = split_into_sentences(req.text or "")

    response: List[Dict[str, Any]] = []

    proc = crim = neut = 0

    for idx, sent in enumerate(sentences, start=1):
        label = classify_sentence(sent)

        if label == "processual":
            proc += 1
        elif label == "criminal":
            crim += 1
        else:
            neut += 1

        response.append({
            "index": idx,
            "type": label,
            "length": len(sent),
            "text": sent
        })

    return {
        "total_sentences": len(sentences),
        "criminal": crim,
        "processual": proc,
        "neutral": neut,
        "facts": response
    }
